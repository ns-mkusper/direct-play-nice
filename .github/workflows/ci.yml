name: CI

on:
  pull_request:
    branches:
      - "**"
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - 'README.md'
      - 'CHANGELOG.md'
      - 'docs/**'
      - 'media/**'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.gif'
      - '**/*.svg'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.prettier*'
      - '.vscode/**'
      - '.idea/**'

env:
  CARGO_TERM_COLOR: always
  CI_BASE_IMAGE: ${{ format('ghcr.io/{0}/direct-play-nice-ci:latest', toLower(github.repository_owner)) }}

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    if: ${{ !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.body, '[skip ci]') }}
    name: Test (Linux)
    runs-on: ubuntu-latest
    container: ${{ env.CI_BASE_IMAGE }}
    permissions:
      contents: read
      actions: write
      packages: read
    env:
      LD_LIBRARY_PATH: /opt/vcpkg/installed/x64-linux/lib
      PKG_CONFIG_PATH: /opt/vcpkg/installed/x64-linux/lib/pkgconfig
    strategy:
      matrix:
        toolchain:
          - stable
          - beta
          - nightly
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
          components: rustfmt
      - name: Set up sccache
        id: sccache-setup
        uses: mozilla-actions/sccache-action@v0.0.5

      - name: Enable sccache if available
        run: |
          if command -v sccache >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
          else
            echo "sccache not found; continuing without compiler cache"
          fi

      - name: Cache cargo build artifacts
        uses: Swatinem/rust-cache@v2

      - name: Compile tests (no run)
        env:
          RUSTC_WRAPPER: ${{ env.RUSTC_WRAPPER }}
        run: cargo test --no-run --verbose

      - name: Run tests
        run: cargo test -q

      - name: sccache stats
        if: ${{ env.RUSTC_WRAPPER == 'sccache' }}
        run: sccache --show-stats || true

  windows-test:
    name: Test (Windows MSVC)
    # Temporarily disabled: vcpkg/libiconv download is flaky and very slow
    # on CI, causing frequent failures. Re-enable when we remove cargo-vcpkg
    # for Windows or switch to prebuilt FFmpeg.
    if: ${{ false }}
    runs-on: windows-latest
    env:
      CARGO_TERM_COLOR: always
      VCPKGRS_TRIPLET: x64-windows-static
    steps:
      - uses: actions/checkout@v3
      - name: Install rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Set up sccache
        id: sccache-setup
        uses: mozilla-actions/sccache-action@v0.0.5

      - name: Test sccache and set wrapper
        id: sccache-check
        shell: pwsh
        env:
          RUSTC_WRAPPER: sccache
        run: |
          try {
            cargo install cargo-vcpkg
            echo "RUSTC_WRAPPER=sccache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } catch {
            echo "RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            throw "sccache failed, proceeding without it."
          }
        continue-on-error: true
      
      - name: Install ffmpeg CLI (for e2e test)
        shell: pwsh
        run: choco install ffmpeg -y

      - name: Build vcpkg dependencies (with binary cache + sccache)
        shell: pwsh
        env:
          VCPKG_FEATURE_FLAGS: manifests,binarycaching
          VCPKG_BINARY_SOURCES: clear;x-gha,readwrite
          VCPKG_CMAKE_CONFIGURE_OPTIONS: -Wno-dev -DCMAKE_POLICY_DEFAULT_CMP0174=NEW
          VCPKG_MAX_CONCURRENCY: 2
          RUSTC_WRAPPER: ${{ env.RUSTC_WRAPPER }}
        run: cargo vcpkg --verbose build

      - name: Compile tests (no run)
        env:
          RUSTC_WRAPPER: ${{ env.RUSTC_WRAPPER }}
        run: cargo test --no-run --verbose

      - name: Run tests
        run: cargo test -q

      - name: sccache stats
        if: ${{ env.RUSTC_WRAPPER == 'sccache' }}
        run: sccache --show-stats || true
